# ì–‘ë°©í–¥ ë§¤í•‘

ë‘ ì—°ê´€ê´€ê³„ ì¤‘ í•˜ë‚˜ë¥¼ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìœ¼ë¡œ ì •í•´ì•¼í•œë‹¤. (mappedByë¡œ í‘œì‹œ â‡’ ì•ˆ ì“°ëŠ” ìª½ì´ ì£¼ì¸)

- ì£¼ì¸
    - db ì—°ê´€ê´€ê³„ì™€ ë§¤í•‘
    - ì™¸ë˜í‚¤ë¥¼ dbì— ë“±ë¡, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŒ.
    - ë§¤í•‘ëœ í…Œì´ë¸”ì— ì™¸ë˜í‚¤ê°€ ìˆëŠ” ìª½.
- ì£¼ì¸ ì•„ë‹Œ ìª½
    - ì½ê¸°ë§Œ ê°€ëŠ¥.

- ë‹¨ë°©í–¥ê³¼ì˜ ì°¨ì´(=ì¥ì ) : ë°˜ëŒ€ë°©í–¥ìœ¼ë¡œ ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ ê¸°ëŠ¥ì´ ì¶”ê°€ë¨

# ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì˜ ì£¼ì˜ì 

```java
 // Member ê°ì²´ ìƒì„±
        Member member = new Member("John Doe");

        // Order ê°ì²´ ìƒì„±
        Order order1 = new Order("Product 1");
        Order order2 = new Order("Product 2");

        // persist: DBì— ì €ì¥
        em.persist(member);

        //ì—°ê´€ê´€ê³„ ì„¤ì • : Order -> Member
        order1.setMember(member);
        order2.setMember(member);
        em.persist(order1);
        em.persist(order2);
        
        Member findMember = em.find(Member.class, member.getId());
        System.out.println("Member: " + findMember.getName());
        System.out.println("Orders:");
        for (Order o : findMember.getOrders()) {
            System.out.println(" - " + o.getProductName());
        }
 
 Hibernate: 
    /* insert for
        sjw.reebservice.domain.Member */insert 
    into
        member (name) 
    values
        (?)
Hibernate: 
    /* insert for
        sjw.reebservice.domain.Order */insert 
    into
        `order` (
            member_id, product_name
        ) 
    values
        (?, ?)
Hibernate: 
    /* insert for
        sjw.reebservice.domain.Order */insert 
    into
        `order` (
            member_id, product_name
        ) 
    values
        (?, ?)
Member: John Doe
Orders://order1, order2ê°€ ì¶œë ¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
```

â€˜ì™¸ë˜í‚¤ë¥¼ ë“±ë¡, ìˆ˜ì •,ì‚­ì œ ê°€ëŠ¥í•œ ìª½ì€ ì—°ê´€ê´€ê³„ ì£¼ì¸ì„ ê°€ì§„ í…Œì´ë¸”ì´ë‹ˆ, ë‹¤ë¥¸ ìª½ì€ êµ³ì´ setí•´ì¤„ í•„ìš”ê°€ ì—†ë‹¤.â€™ê³  ìƒê°í•  ìˆ˜ ìˆëŠ”ë°, ì´ì²˜ëŸ¼ ê°ì²´ì—ëŠ” ë°˜ì˜ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤. (em.flush() í›„ em.find(member.class)í•˜ë©´ dbì—ì„œ ê°€ì ¸ì˜¤ë¯€ë¡œ ë°˜ì˜ì´ ëœë‹¤.)

- ë”°ë¼ì„œ ê°ì²´ì˜ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ëŠ” ì–‘ìª½ ëª¨ë‘ ê´€ê³„ë¥¼ ë§ºì–´ì¤˜ì•¼í•œë‹¤.

ì•„ë‹ˆ ê·¸ëŸ¼ ë§¤ë²ˆ ì¼ì¼ì´ ì‹ ê²½ ì¨ì•¼í•˜ëŠ”ê°€?

# ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ

ì—°ê´€ê´€ê³„ ì£¼ì¸ì˜ setterì—ì„œ ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ ì•„ë‹Œ ìª½ì˜ setê¹Œì§€ í•˜ë©´ ëœë‹¤!

```java
//Order class
    @ManyToOne
    @JoinColumn(name = "member_id")
    private Member member;
    
    public void setMember(Member member){
	    this.member = member;
	    member.getOrders().add(this);
    }
```

ì§œì”! ë!

ì´ ì•„ë‹ˆë‹¤.

```java
order.setMember(mem1);
order.setMember(mem2);
Order findOrder = mem1.getMember();//ì—¬ì „íˆ orderì´ ì¡°íšŒëœë‹¤.
```
![image.png](./imgs/img1.png)
![image.png](./imgs/img2.png)

ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ ì•„ë‹Œ ìª½ì˜ ì—°ê´€ê´€ê³„ê°€ ëŠì–´ì§€ì§€ ì•Šì•˜ë‹¤.

- db ìƒì—ëŠ” ë¬¸ì œê°€ ì—†ë‹¤.(ì—°ê´€ê´€ê³„ ì£¼ì¸ì˜ ì„¤ì •ë§Œì´ ë°˜ì˜ë˜ë¯€ë¡œ)
- ê°ì²´ ìƒì—ëŠ” ë¬¸ì œê°€ ìˆë‹¤(ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ ì•„ë‹Œ ìª½ì—ì„œëŠ” ê³„ì† ì¡°íšŒê°€ ëœë‹¤.)

```java
//Order class
    @ManyToOne
    @JoinColumn(name = "member_id")
    private Member member;
    
    public void setMember(Member member){
	    if(this.member != null)
		    this.member.getOrders().remove(this); // ì—°ê´€ê´€ê³„ ì£¼ì¸ ì•„ë‹Œ ìª½ì„ ëŠì–´ë‚´ê¸°//Order class    @ManyToOne    @JoinColumn(name = "member_id")    private Member member;        public void setMember(Member member){	    if(this.member != null)		    this.member.getOrders().remove(this); // ì—°ê´€ê´€ê³„ ì£¼ì¸ ì•„ë‹Œ ìª½ì„ ëŠì–´ë‚´ê¸°
	    this.member = member;
	    member.getOrders().add(this);
    }
```


# ì¼ëŒ€ë‹¤ ë‹¨ë°©í–¥ ë§¤í•‘ (@OneToMany)

- ë§¤í•‘í•œ ê°ì²´ê°€ ê´€ë¦¬í•˜ëŠ” ì™¸ë˜í‚¤ê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì— ìˆë‹¤
- ë§¤í•‘ ê°ì²´ == ì™¸ë˜í‚¤ ê°€ì§„ í…Œì´ë¸” â‡’ INSERT ë¬¸ìœ¼ë¡œ ëë‚¨
- ë§¤í•‘ ê°ì²´ â‰  ì™¸ë˜í‚¤ ê°€ì§„ í…Œì´ë¸” â‡’ UPDATEë¬¸ë„ ë°œìƒ!!!

```java
@Entity
public class Team{
	@Id @GeneratedValue
	@Column(name="TEAM_ID")
	private Long id;
	
	private String name;
	
	@OneToMany
	@JoinColumn(name="TEAM_ID") // ë°˜ëŒ€í¸ í…Œì´ë¸”(member)ì˜ ì™¸ë˜í‚¤ team_id
	private List<Member> members = new ArrayList<Member>();
	//Getter, Setter
}

@Entity
public class Member{
	@Id @GeneratedValue
	@Column(name="member_id")
	private Long id;
	
	private String username;
	//Getter, Setter
}

//ì‹¤í–‰ ì‹œ
Member mem1 = new Member("mem1");
Member mem2 = new Member("mem2");

Team team1 = new Team("team1");
team1.getMembers().add(mem1);
team1.getMembers().add(mem2);

em.persist(mem1); // insert mem1
em.persist(mem2); // insert mem2
em.persist(team1); // insert team1, update mem1.fk, update mem2.fk
```

- ì—”í‹°í‹°ë¥¼ ë§¤í•‘í•œ í…Œì´ë¸”ì´ ì•„ë‹Œ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ì™¸ë˜í‚¤ë¥¼ ê´€ë¦¬
- ì„±ëŠ¥ë¬¸ì œì™€ ê´€ë¦¬ ë¬¸ì œ ì´ˆë˜
- ë”°ë¼ì„œ ì¼ëŒ€ë‹¤ ë‹¨ë°©í–¥ ëŒ€ì‹  ë‹¤ëŒ€ì¼ ì–‘ë°©í–¥ ë§¤í•‘ì„ ì‚¬ìš©.


# ì¼ëŒ€ì¼ @OneToOne

- ì£¼ í…Œì´ë¸”ì— ì™¸ë˜í‚¤
    - ê°ì²´ ì§€í–¥ì  ê´€ì 
    - ì™¸ë˜í‚¤ë¥¼ ê°ì²´ ì°¸ì¡°ì™€ ë¹„ìŠ·í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥.
- ëŒ€ìƒ í…Œì´ë¸”ì— ì™¸ë˜í‚¤
    - ì „í†µì ì¸ db ë°©ì‹ì—ì„œ ì„ í˜¸ë¨
    - í…Œì´ë¸” ê´€ê³„ë¥¼ ì¼ëŒ€ì¼ì—ì„œ ì¼ëŒ€ë‹¤ë¡œ ë³€ê²½í•  ë•Œ í…Œì´ë¸” êµ¬ì¡°ê°€ ìœ ì§€ë  ìˆ˜ ìˆìŒ

ì£¼ / ëŒ€ìƒ í…Œì´ë¸” êµ¬ë¶„ì€ í˜„ì‹¤ì—ì„œ ë³¼ ë•Œ ì†Œìœ ê´€ê³„ë¡œ ì§€ì •í•  ìˆ˜ ìˆëŠ”ë“¯.

ex) ì£¼ : member / ëŒ€ìƒ : locker

@OneToOneì„ memberì—ëŠ” ë¬´ì¡°ê±´ ê±´ë‹¤ê³  ìƒê°í–ˆì„ ë•Œ, ì–´ë–¤ ê²½ìš°ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆì„ê¹Œ?

- ì£¼í…Œì´ë¸”ì— ì™¸ë˜í‚¤ê°€ ìˆëŠ” ê²½ìš° : ë‹¨ë°©í–¥, ì–‘ë°©í–¥
    ![image.png](./imgs/img6.png)

- ëŒ€ìƒí…Œì´ë¸”ì— ì™¸ë˜í‚¤ ìˆëŠ” ê²½ìš° : ì–‘ë°©í–¥ ê°€ëŠ¥
    - ë‹¨ë°©í–¥ ë¶ˆê°€ëŠ¥
        - @OneToOneì„ memberì— ê±¸ì–´ë†“ê³ , ì‹¤ì œ ì™¸ë˜í‚¤ëŠ” locker í…Œì´ë¸”ì— ìˆëŠ”ë‹¤? â‡’ ë¶ˆê°€ëŠ¥
        - ë‹¨ë°©í–¥ ê´€ê³„ë¥¼ locker â†’member ë°©í–¥ìœ¼ë¡œ ë°”ê¿”ì•¼í•¨.
![image.png](./imgs/img7.png)

```java
@Entity
public class Member {
	@Id @GeneratedValue
	@Column(name="MEMBER_ID")
	private Long id;
	
	private String username;
	
	@OneToOne(mappedBy="member")
	private Locker locker;
}

@Entity
public class Locker{
	@Id @GeneratedValue	
	@Column(name="LOCKER_ID")
	private Long id;
	
	private String name;
	
	@OneToOne
	@JoinColumn(name="MEMBER_ID")
	private Member member;
}
```
![image.png](./imgs/img8.png)


<aside>
ğŸ’¡

í”„ë¡ì‹œ ì‚¬ìš© ì‹œ ì™¸ë˜í‚¤ë¥¼ ì§ì ‘ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì¼ëŒ€ì¼ ê´€ê³„ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ë„ ì¦‰ì‹œ ë¡œë”©ëœë‹¤.

Locker.memberëŠ” ì§€ì—° ë¡œë”©í•  ìˆ˜ ìˆì§€ë§Œ, Member.lockerëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ë„ ì¦‰ì‹œ ë¡œë”©ëœë‹¤.

í”„ë¡ì‹œì˜ í•œê³„ ë•Œë¬¸ì¸ë°, í”„ë¡ì‹œ ëŒ€ì‹  bytecode instrumentationì„ ì‚¬ìš©í•˜ë©´ í•´ê²° ê°€ëŠ¥.

</aside>

# ë‹¤ëŒ€ë‹¤ @ManyToMany

- í…Œì´ë¸”ì€ n:mì¸ ê²½ìš° 1:n, n:1 ê´€ê³„ë¡œ ìª¼ê°œì–´ ì¤‘ê°„ì— ì—°ê²° í…Œì´ë¸”ì„ ë‘”ë‹¤.
- ê°ì²´ëŠ” ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

ë‹¤ëŒ€ë‹¤ ë‹¨ë°©í–¥

```java
@Entity
public class Member {
	@Id @Column(name="MEMBER_ID")
	private String id;
	
	private String username;
	
	@ManyToMany // ë‹¤ëŒ€ë‹¤ ë§¤í•‘
	@JoinTable(name="MEMBER_PRODUCT", // ì—°ê²° í…Œì´ë¸” ë°”ë¡œ ë§¤í•‘
		joinColumns = @JoinColumn(name="MEMBER_ID"),
		inverseJoinColumns = @JoinColumn(name = "PRODUCT_ID"))
	private List<Product> products = new ArrayList<Product>();
}

@Entity
public class Product {
	@Id @Column(name="PRODUCT_ID")
	private String id;
	private String name;
}
```

```java
ë‹¤ëŒ€ë‹¤ ê´€ê³„ ì €ì¥ ì˜ˆì œ
public void save(){
	Product poduct1 = new Product();
	product1.setId("product1");
	product1.setName("ìƒí’ˆ1");
	em.persist(product1);
	
	Member mem1 = new Member();
	mem1.setId("mem1");
	mem1.setUsername("kim");
	mem1.getProducts().add(product1);
	em.persist(mem1);
}

//ì‹¤í–‰ë˜ëŠ” DDL
INSERT INTO PRODUCT
INSERT INTO MEMBER
INSERT INTO MEMBER_PRODUCT

íƒìƒ‰
public void find(){
	Member member = em.find(Member.class, "mem1");
	List<Product> products = member.getProducts();
	for(Product product : products){
		System.out.println("product.name = " + product.getName();
	}
}

SELECT * FROM MEMBER_PRODUCT MP
INNER JOIN PRODUCT P ON MP.PRODUCT_ID = P.PRODUCT_ID
WHERE MP.MEMBER_ID=?
```

ë‹¤ëŒ€ë‹¤ ì–‘ë°©í–¥

```java
@Entity
public class Member {
	@Id @Column(name="MEMBER_ID")
	private String id;
	
	private String username;
	
	@ManyToMany // ë‹¤ëŒ€ë‹¤ ë§¤í•‘
	@JoinTable(name="MEMBER_PRODUCT", // ì—°ê²° í…Œì´ë¸” ë°”ë¡œ ë§¤í•‘
		joinColumns = @JoinColumn(name="MEMBER_ID"),
		inverseJoinColumns = @JoinColumn(name = "PRODUCT_ID"))
	private List<Product> products = new ArrayList<Product>();
	
	public void addProduct(Product product){ //ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ
		...
		products.add(product);
		product.getMembers().add(this);
	}
}

@Entity
public class Product {
	@Id @Column(name="PRODUCT_ID")
	private String id;
	private String name;
	
	@ManyToMany(mappedBy="products") //ì–‘ë°©í–¥ ë§¤í•‘
	private List<Member> members;
}
```

ë‹¤ëŒ€ë‹¤ ë§¤í•‘ì˜ í•œê³„

- íšŒì›ì´ ìƒí’ˆì„ ì£¼ë¬¸í•˜ë©´ ì—°ê²°í…Œì´ë¸”ì— ë‹¨ìˆœíˆ íšŒì›idì™€ ìƒí’ˆidë¥¼ ë‹´ê³  ëë‚˜ì§€ ì•ŠëŠ”ë‹¤.
- ì£¼ë¬¸ ìˆ˜ëŸ‰, ì£¼ë¬¸ë‚ ì§œ ë“±ì˜ ì¹¼ëŸ¼ì´ ë” í•„ìš”í•˜ë‹¤

- 

```java
ì¤‘ê°„í…Œì´ë¸”
@Entity
@IdClass(MemberProductId.class) // ë³µí•©ê¸°ë³¸í‚¤ ë§¤í•‘
public class MemberProduct{
	@Id // ê¸°ë³¸í‚¤ ë§¤í•‘
	@ManyToOne
	@JoinColumn(name="MEMBER_ID") // ì™¸ë˜í‚¤ ë§¤í•‘
	private Member member; //ë¶€ëª¨ í…Œì´ë¸”ì˜ ê¸°ë³¸í‚¤ë¥¼ ìì‹ ì˜ ê¸°ë³¸í‚¤+ì™¸ë˜í‚¤ë¡œ ì‚¬ìš© = ì‹ë³„ê´€ê³„
	
	@Id
	@ManyToOne
	@JoinColumn(name="PRODUCT_ID")
	private Product product;
	
	private int orderAmount;
}

//ì‹ë³„ì í´ë˜ìŠ¤
public class MemberProductId implements Serializable{
	private String member; // MemberProduct.memberì™€ ì—°ê²°
	private String product; // MemberProduct.productì™€ ì—°ê²°
	
	@Override
	public boolean equals(Object o){...}
	
	@Override
	public int hashCode(){...}
}
```

## ** ë³µí•© ê¸°ë³¸í‚¤

- ë³„ë„ì˜ ì‹ë³„ì í´ë˜ìŠ¤ë¡œ ë§Œë“  í›„, ì—”í‹°í‹°ì— @IdClassë¡œ ì—°ê²°(í˜¹ì€ @EmbeddedId)
- Serializable êµ¬í˜„
- equals(), hashCode() êµ¬í˜„
- public í´ë˜ìŠ¤

**ë³µí•©í‚¤ ê´€ë¦¬ëŠ” ê¹Œë‹¤ë¡œìš°ë¯€ë¡œ, ìƒˆë¡œìš´ ê¸°ë³¸í‚¤ë¥¼ ì§€ì •í•˜ì—¬ ë¹„ì‹ë³„ê´€ê³„ë¡œ êµ¬í˜„í•˜ê¸°ë„ í•œë‹¤.